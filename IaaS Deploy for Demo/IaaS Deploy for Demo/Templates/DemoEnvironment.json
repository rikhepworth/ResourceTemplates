{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "envPrefix": {
          "type": "string",
          "defaultValue": "demo",
          "metadata": {
            "description": "Common prefix for all resource naming"
          }
        },
        "envLocation": {
            "type": "string",
            "defaultValue": "North Europe",
            "allowedValues": [
                "North Europe",
                "West Europe"
            ],
            "metadata": {
                "description": "Location for all resources"
            }
        },
        "adminUsername": {
          "type": "string",
          "defaultValue": "demoadmin"
            "metadata": {
                "description": "Admin username for environment"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Admin password for environment"
            }
        },
      "_artifactsLocation": {
        "type": "string",
        "defaultValue": "https://raw.githubusercontent.com/rikhepworth/ResourceTemplates/IaaS%20Deploy%20For%20Demo/",
        "metadata": {
          "description": "Storage Account/GitHub base uri for required files"
        }
      },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "Secure Access Token for Azure Storage Account"
            }
        }
    },
    "variables": {
        "StorageAccount": {
            "Name": "[concat(parameters('envPrefix'),'storage')]",
            "Type": "Standard_LRS",
            "Location": "[parameters('envLocation')]"
        },
        "VirtualNetwork": {
            "Name": "[concat(parameters('envPrefix'), 'network')]",
            "Location": "[parameters('envLocation')]",
            "Prefix": "192.168.0.0/16",
            "Subnet1Name": "Subnet-1",
            "Subnet1Prefix": "192.168.1.0/24"
        },
        "StdVmImageReference": {
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2012-R2-Datacenter",
            "version": "latest"
        },
        "domainName": "[concat(parameters('envPrefix'), '.local')]",
        "WAPPublicDNS": "[concat(parameters('envPrefix'), 'fed')]",
        "WebPublicDNS": "[concat(parameters('envPrefix'), 'api')]",
        "vmNames": {
            "dc": "DC",
            "adfs": "ADFS",
            "wap": "WAP"
        }
    },
    "resources": [
        {
            "name": "NetworkAndStorage",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [ ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/NetworkAndStorage.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "StorageAccount": {
                        "value": "[variables('StorageAccount')]"
                    }
                }
            }
        },
        {
            "name": "DomainController",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "NetworkAndStorage"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/DomainController.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "VirtualNetworkId": {
                        "value": "[reference('NetworkAndStorage').outputs.VirtualNetworkId.value]"
                    },
                    "StorageAccount": {
                        "value": "[variables('StorageAccount')]"
                    },
                    "StorageAccountId": {
                        "value": "[reference('NetworkAndStorage').outputs.StorageAccountId.value]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "vmImageReference": {
                        "value": "[variables('StdVmImageReference')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').dc]"
                    }
                }
            }
        },
        {
            "name": "UpdateVNetDNS",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "NetworkAndStorage",
                "DomainController",
                "DomainControllerDSC"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/UpdateVNetDNS.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "DNSaddress": {
                        "value": "[reference('DomainController').outputs.ipAddress.value]"
                    }
                }
            }
        },
        {
            "name": "ADFSserver",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "NetworkAndStorage"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/ADFSserver.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "VirtualNetworkId": {
                        "value": "[reference('NetworkAndStorage').outputs.VirtualNetworkId.value]"
                    },
                    "StorageAccount": {
                        "value": "[variables('StorageAccount')]"
                    },
                    "StorageAccountId": {
                        "value": "[reference('NetworkAndStorage').outputs.StorageAccountId.value]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "vmImageReference": {
                        "value": "[variables('StdVmImageReference')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').adfs]"
                    }
                }
            }
        },
        {
            "name": "WAPServer",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "NetworkAndStorage"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/WAPServer.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "VirtualNetworkId": {
                        "value": "[reference('NetworkAndStorage').outputs.VirtualNetworkId.value]"
                    },
                    "StorageAccount": {
                        "value": "[variables('StorageAccount')]"
                    },
                    "StorageAccountId": {
                        "value": "[reference('NetworkAndStorage').outputs.StorageAccountId.value]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "vmImageReference": {
                        "value": "[variables('StdVmImageReference')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').wap]"
                    }
                }
            }
        },
        {
            "name": "DomainControllerDSC",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "DomainController"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/DomainControllerDSC.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "domainName": {
                        "value": "[variables('domainName')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').dc]"
                    }

                }
            }
        },
        {
            "name": "DomainControllerCS",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [
                "DomainController",
                "DomainControllerDSC",
                "ADFSserverDSC",
                "WAPServerDSC"
            ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/DomainControllerCS.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "WAPPublicDNS": {
                        "value": "[reference('WAPServer').outputs.wapfqdn.value]"
                    },
                    "WebPublicDNS": {
                        "value": "[variables('domainName')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').dc]"
                    }

                }
            }
        },
        {
            "name": "ADFSserverDSC",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [ "DomainControllerDSC", "ADFSserver", "UpdateVNetDNS" ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/ADFSserverDSC.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "domainName": {
                        "value": "[variables('domainName')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').adfs]"
                    }
                }
            }
        },
        {
            "name": "ADFSserverCS",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [ "DomainControllerCS" ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/ADFSserverCS.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "WAPPublicDNS": {
                        "value": "[reference('WAPServer').outputs.wapfqdn.value]"
                    },
                    "WebPublicDNS": {
                        "value": "[variables('domainName')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').adfs]"
                    }
                }
            }
        },
        {
            "name": "WAPServerDSC",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [ "DomainControllerDSC", "WAPServer", "UpdateVNetDNS" ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/WAPServerDSC.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "domainName": {
                        "value": "[variables('domainName')]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').wap]"
                    }
                }
            }
        },
        {
            "name": "WAPServerCS",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2015-01-01",
            "dependsOn": [ "ADFSserverCS" ],
            "properties": {
                "mode": "Incremental",
              "templateLink": {
                "uri": "[concat(parameters('_artifactsLocation'), 'Templates/NestedDeploy/WAPServerCS.json', parameters('_artifactsLocationSasToken'))]",
                "contentVersion": "1.0.0.0"
              },
                "parameters": {
                    "VirtualNetwork": {
                        "value": "[variables('VirtualNetwork')]"
                    },
                    "AdminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "envPrefix": {
                        "value": "[parameters('envPrefix')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    },
                    "WAPPublicDNS": {
                        "value": "[reference('WAPServer').outputs.wapfqdn.value]"
                    },
                    "vmName": {
                        "value": "[variables('vmNames').wap]" 
                    }
                }
            }
        }
    ],
    "outputs": {

    }
}
